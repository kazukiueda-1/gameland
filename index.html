<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ãã‚ããƒ©ãƒ³ãƒ‰</title>
    <!-- ãƒ•ã‚©ãƒ³ãƒˆ: ãœã‚“ã¾ã‚‹ã‚´ã‚·ãƒƒã‚¯ -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Zen Maru Gothic"', 'sans-serif'] },
                    colors: {
                        sky: { 300: '#7DD3FC', 100: '#E0F2FE' },
                        grass: { 100: '#F0FFF4' },
                        paper: '#FFF5F7'
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'float-delay': 'float 6s ease-in-out 2s infinite',
                        'twinkle': 'twinkle 2s ease-in-out infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'pop': 'pop 0.3s ease-out forwards',
                        'spin-slow': 'spin 3s linear infinite'
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-15px)' } },
                        twinkle: { '0%, 100%': { opacity: '1', transform: 'scale(1)' }, '50%': { opacity: '0.5', transform: 'scale(0.8)' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } },
                        pop: { '0%': { transform: 'scale(0.8)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        /* ãƒ†ãƒ¼ãƒåˆ¥èƒŒæ™¯ */
        body {
            font-family: "Zen Maru Gothic", sans-serif;
            background-attachment: fixed;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        /* ãƒ†ãƒ¼ãƒ1: ã‹ã‚ã„ã„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */
        body.theme-cute {
            background: linear-gradient(135deg, #FFE4EC 0%, #E8D5F2 30%, #D4E5F7 60%, #FFE4EC 100%);
        }
        body.theme-cute .nav-border { border-color: #F9A8D4; }
        body.theme-cute .nav-title { background-image: linear-gradient(to right, #F472B6, #A78BFA, #60A5FA); }
        body.theme-cute .star-badge { background: linear-gradient(to right, #FCD34D, #FB923C); border-color: #FBBF24; }

        /* ãƒ†ãƒ¼ãƒ2: ã‹ã£ã“ã„ã„ï¼ˆç”·ã®å­å‘ã‘ï¼‰ */
        body.theme-cool {
            background: linear-gradient(135deg, #0F172A 0%, #1E3A5F 30%, #0D9488 60%, #1E3A5F 100%);
        }
        body.theme-cool .nav-border { border-color: #22D3EE; }
        body.theme-cool .nav-title { background-image: linear-gradient(to right, #22D3EE, #34D399, #FBBF24); }
        body.theme-cool .star-badge { background: linear-gradient(to right, #F59E0B, #EF4444); border-color: #F59E0B; }

        /* ãƒ†ãƒ¼ãƒ3: ã‚¹ãƒãƒ¼ãƒˆï¼ˆé«˜å­¦å¹´å‘ã‘ï¼‰ */
        body.theme-smart {
            background: linear-gradient(135deg, #F1F5F9 0%, #E2E8F0 30%, #CBD5E1 60%, #F1F5F9 100%);
        }
        body.theme-smart .nav-border { border-color: #94A3B8; }
        body.theme-smart .nav-title { background-image: linear-gradient(to right, #475569, #64748B, #475569); }
        body.theme-smart .star-badge { background: linear-gradient(to right, #64748B, #475569); border-color: #64748B; }
        /* æµ®ã‹ã¶è£…é£¾ */
        .floating-decorations {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }
        .floating-decorations span {
            position: absolute;
            font-size: 24px;
            opacity: 0.6;
            animation: floatUp 15s linear infinite;
        }
        @keyframes floatUp {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }
        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ç”¨ - ãƒ†ãƒ¼ãƒåˆ¥ */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #login-screen::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image:
                radial-gradient(circle at 20% 30%, rgba(255,255,255,0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255,255,255,0.2) 0%, transparent 40%);
            pointer-events: none;
        }
        body.theme-cute #login-screen { background: linear-gradient(135deg, #FFB6C1 0%, #DDA0DD 50%, #87CEEB 100%); }
        body.theme-cool #login-screen { background: linear-gradient(135deg, #0F172A 0%, #1E40AF 50%, #0D9488 100%); }
        body.theme-smart #login-screen { background: linear-gradient(135deg, #64748B 0%, #475569 50%, #334155 100%); }

        /* å­ä¾›ã‚«ãƒ¼ãƒ‰ */
        .child-card {
            background: rgba(255,255,255,0.9);
            border-radius: 1rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
        }
        .child-card:hover {
            transform: scale(1.05);
            border-color: #F472B6;
        }
        .child-card:active {
            transform: scale(0.95);
        }
        body.theme-cool .child-card {
            background: rgba(30, 41, 59, 0.9);
            color: white;
        }
        body.theme-cool .child-card:hover {
            border-color: #22D3EE;
        }
        body.theme-smart .child-card {
            background: rgba(255,255,255,0.95);
        }
        body.theme-smart .child-card:hover {
            border-color: #64748B;
        }

        /* PINå…¥åŠ›ãƒ‰ãƒƒãƒˆ */
        .pin-dot.filled {
            background: #F472B6 !important;
            transform: scale(1.2);
        }
        body.theme-cool .pin-dot.filled {
            background: #22D3EE !important;
        }
        body.theme-smart .pin-dot.filled {
            background: #64748B !important;
        }

        /* PINå…¥åŠ›ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ - ãƒ†ãƒ¼ãƒåˆ¥ */
        body.theme-cool .pin-key {
            background: #1E293B;
            border-color: #334155;
            color: white;
        }
        body.theme-cool .pin-key:hover {
            background: #334155;
        }
        body.theme-cool #selected-child-name {
            color: white;
        }

        /* ãƒ­ãƒƒã‚¯ç”»é¢ã‚«ãƒ¼ãƒ‰ã®ãƒ†ãƒ¼ãƒåˆ¥ã‚¹ã‚¿ã‚¤ãƒ« */
        body.theme-cute .lock-card { background: rgba(255,255,255,0.95); border-color: #F9A8D4; }
        body.theme-cute .lock-card .lock-title { background-image: linear-gradient(to right, #F472B6, #A78BFA, #60A5FA); }
        body.theme-cute .lock-card .lock-hint { color: #F472B6; }
        body.theme-cute .lock-card input { background: #FDF2F8; border-color: #FBCFE8; }
        body.theme-cute .lock-card input:focus { border-color: #F472B6; }
        body.theme-cute .lock-card .lock-btn { background: linear-gradient(to right, #F472B6, #A78BFA); }

        body.theme-cool .lock-card { background: rgba(15,23,42,0.95); border-color: #22D3EE; }
        body.theme-cool .lock-card .lock-title { background-image: linear-gradient(to right, #22D3EE, #34D399, #FBBF24); }
        body.theme-cool .lock-card .lock-hint { color: #22D3EE; }
        body.theme-cool .lock-card input { background: #1E293B; border-color: #334155; color: white; }
        body.theme-cool .lock-card input::placeholder { color: #64748B; }
        body.theme-cool .lock-card input:focus { border-color: #22D3EE; }
        body.theme-cool .lock-card .lock-btn { background: linear-gradient(to right, #0891B2, #059669); }

        body.theme-smart .lock-card { background: rgba(255,255,255,0.95); border-color: #94A3B8; }
        body.theme-smart .lock-card .lock-title { background-image: linear-gradient(to right, #475569, #64748B, #475569); }
        body.theme-smart .lock-card .lock-hint { color: #64748B; }
        body.theme-smart .lock-card input { background: #F1F5F9; border-color: #CBD5E1; }
        body.theme-smart .lock-card input:focus { border-color: #64748B; }
        body.theme-smart .lock-card .lock-btn { background: linear-gradient(to right, #475569, #64748B); }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼è£…é£¾ - ãƒ†ãƒ¼ãƒåˆ¥ */
        ::-webkit-scrollbar { width: 8px; }
        body.theme-cute ::-webkit-scrollbar-track { background: rgba(255,182,193,0.2); }
        body.theme-cute ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #FFB6C1, #DDA0DD); border-radius: 4px; }
        body.theme-cool ::-webkit-scrollbar-track { background: rgba(34,211,238,0.1); }
        body.theme-cool ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #0891B2, #059669); border-radius: 4px; }
        body.theme-smart ::-webkit-scrollbar-track { background: rgba(148,163,184,0.2); }
        body.theme-smart ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #64748B, #475569); border-radius: 4px; }
        /* è™¹è‰²ãƒœãƒ¼ãƒ€ãƒ¼ */
        .rainbow-border {
            border-image: linear-gradient(90deg, #FF9AA2, #FFB7B2, #FFDAC1, #E2F0CB, #B5EAD7, #C7CEEA) 1;
        }
        /* æ¨ªå‘ãï¼ˆãƒ©ãƒ³ãƒ‰ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰å¯¾å¿œ */
        @media (orientation: landscape) and (max-height: 500px) {
            .landscape\:flex-row { flex-direction: row !important; }
            .landscape\:items-start { align-items: flex-start !important; }
            .landscape\:gap-6 { gap: 1.5rem !important; }
            .landscape\:flex-shrink-0 { flex-shrink: 0 !important; }
            .landscape\:flex-1 { flex: 1 1 0% !important; }
        }
        /* é€šçŸ¥ãƒãƒƒã‚¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes badge-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        #message-badge:not(.hidden) {
            animation: badge-pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 theme-cute">

    <!-- â–¼â–¼â–¼ 1. ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ (å­ä¾›é¸æŠ + PINå…¥åŠ›) â–¼â–¼â–¼ -->
    <div id="login-screen">
        <!-- æµ®ã‹ã¶è£…é£¾ -->
        <div id="lock-decorations" class="absolute inset-0 overflow-hidden pointer-events-none">
            <!-- ãƒ†ãƒ¼ãƒã«å¿œã˜ã¦å‹•çš„ã«ç”Ÿæˆ -->
        </div>

        <!-- å­ä¾›é¸æŠç”»é¢ -->
        <div id="child-select-screen" class="lock-card backdrop-blur p-8 rounded-3xl shadow-2xl max-w-md w-full text-center mx-4 border-4 relative z-10">
            <div class="text-6xl mb-4 animate-float" id="lock-icon">ğŸ°</div>
            <h2 class="lock-title text-2xl font-black bg-clip-text text-transparent mb-4">ã‚ãã‚ããƒ©ãƒ³ãƒ‰</h2>
            <p class="lock-hint mb-6 font-bold text-sm">âœ¨ ã ã‚ŒãŒ ã‚ãã¶ï¼Ÿ âœ¨</p>

            <div id="children-grid" class="grid grid-cols-2 gap-4 mb-6">
                <!-- å­ä¾›ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                <div class="text-gray-400 col-span-2 py-8">
                    <div class="text-4xl mb-2 animate-spin">â³</div>
                    <p class="font-bold">ã‚ˆã¿ã“ã¿ã¡ã‚…ã†...</p>
                </div>
            </div>

            <button onclick="showAddChildForm()" id="add-child-btn" class="lock-btn w-full text-white font-bold py-3 rounded-full shadow-lg active:scale-95 transition text-lg hover:opacity-90">
                â• ã¤ã„ã‹
            </button>
        </div>

        <!-- å­ä¾›è¿½åŠ ç”»é¢ -->
        <div id="add-child-screen" class="lock-card backdrop-blur p-6 rounded-3xl shadow-2xl max-w-sm w-full text-center mx-4 border-4 relative z-10 hidden">
            <button onclick="hideAddChildForm()" class="absolute top-4 left-4 text-gray-500 hover:text-gray-700 font-bold text-lg">
                â† ã‚‚ã©ã‚‹
            </button>

            <div class="text-5xl mb-2 mt-4" id="new-child-avatar-preview">ğŸ‘§</div>
            <h3 class="text-xl font-black text-gray-700 mb-4">ã‚ãŸã‚‰ã—ã„ ãªã‹ã¾</h3>

            <div class="space-y-4 text-left">
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">ãªã¾ãˆ</label>
                    <input type="text" id="new-child-name" placeholder="ã²ã‚‰ãŒãªã§ ã„ã‚Œã¦ã­"
                        class="w-full border-2 rounded-xl py-2 px-3 text-lg font-bold focus:outline-none focus:border-pink-400">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">PINï¼ˆ4ã‘ãŸã® ã™ã†ã˜ï¼‰</label>
                    <input type="text" id="new-child-pin" placeholder="1234" maxlength="4" inputmode="numeric"
                        class="w-full border-2 rounded-xl py-2 px-3 text-lg font-bold tracking-widest focus:outline-none focus:border-pink-400">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-2">ã‚¢ãƒã‚¿ãƒ¼</label>
                    <div class="flex flex-wrap gap-2 justify-center" id="avatar-picker">
                        <!-- ã‚¢ãƒã‚¿ãƒ¼é¸æŠãƒœã‚¿ãƒ³ -->
                    </div>
                    <input type="hidden" id="new-child-avatar" value="ğŸ‘§">
                </div>
            </div>

            <button onclick="saveNewChild()" id="save-child-btn" class="lock-btn w-full text-white font-bold py-3 rounded-full shadow-lg active:scale-95 transition text-lg hover:opacity-90 mt-6">
                âœ¨ ã¤ã„ã‹ï¼
            </button>
            <p id="add-child-error" class="text-red-400 font-bold mt-3 hidden text-sm"></p>
        </div>

        <!-- PINå…¥åŠ›ç”»é¢ -->
        <div id="pin-input-screen" class="lock-card backdrop-blur p-6 rounded-3xl shadow-2xl max-w-sm w-full text-center mx-4 border-4 relative z-10 hidden">
            <button onclick="backToChildSelect()" class="absolute top-4 left-4 text-gray-500 hover:text-gray-700 font-bold text-lg">
                â† ã‚‚ã©ã‚‹
            </button>

            <div class="text-5xl mb-2 mt-4" id="selected-child-avatar">ğŸ‘§</div>
            <h3 class="text-xl font-black text-gray-700 mb-4" id="selected-child-name">ã‹ã‚Šã‚“</h3>

            <p class="lock-hint mb-4 font-bold text-sm">ğŸ”¢ ã°ã‚“ã”ã† ã‚’ ã„ã‚Œã¦ã­</p>

            <!-- PINè¡¨ç¤º -->
            <div class="flex justify-center gap-3 mb-6">
                <div class="pin-dot w-5 h-5 rounded-full bg-gray-300 transition-all"></div>
                <div class="pin-dot w-5 h-5 rounded-full bg-gray-300 transition-all"></div>
                <div class="pin-dot w-5 h-5 rounded-full bg-gray-300 transition-all"></div>
                <div class="pin-dot w-5 h-5 rounded-full bg-gray-300 transition-all"></div>
            </div>

            <!-- æ•°å­—ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ -->
            <div class="grid grid-cols-3 gap-2 max-w-[240px] mx-auto">
                <button onclick="enterPin('1')" class="pin-key bg-white hover:bg-gray-100 border-2 border-gray-200 rounded-xl py-4 text-2xl font-black text-gray-700 active:scale-95 transition">1</button>
                <button onclick="enterPin('2')" class="pin-key bg-white hover:bg-gray-100 border-2 border-gray-200 rounded-xl py-4 text-2xl font-black text-gray-700 active:scale-95 transition">2</button>
                <button onclick="enterPin('3')" class="pin-key bg-white hover:bg-gray-100 border-2 border-gray-200 rounded-xl py-4 text-2xl font-black text-gray-700 active:scale-95 transition">3</button>
                <button onclick="enterPin('4')" class="pin-key bg-white hover:bg-gray-100 border-2 border-gray-200 rounded-xl py-4 text-2xl font-black text-gray-700 active:scale-95 transition">4</button>
                <button onclick="enterPin('5')" class="pin-key bg-white hover:bg-gray-100 border-2 border-gray-200 rounded-xl py-4 text-2xl font-black text-gray-700 active:scale-95 transition">5</button>
                <button onclick="enterPin('6')" class="pin-key bg-white hover:bg-gray-100 border-2 border-gray-200 rounded-xl py-4 text-2xl font-black text-gray-700 active:scale-95 transition">6</button>
                <button onclick="enterPin('7')" class="pin-key bg-white hover:bg-gray-100 border-2 border-gray-200 rounded-xl py-4 text-2xl font-black text-gray-700 active:scale-95 transition">7</button>
                <button onclick="enterPin('8')" class="pin-key bg-white hover:bg-gray-100 border-2 border-gray-200 rounded-xl py-4 text-2xl font-black text-gray-700 active:scale-95 transition">8</button>
                <button onclick="enterPin('9')" class="pin-key bg-white hover:bg-gray-100 border-2 border-gray-200 rounded-xl py-4 text-2xl font-black text-gray-700 active:scale-95 transition">9</button>
                <button onclick="clearPin()" class="pin-key bg-gray-100 hover:bg-gray-200 border-2 border-gray-200 rounded-xl py-4 text-xl font-black text-gray-500 active:scale-95 transition">C</button>
                <button onclick="enterPin('0')" class="pin-key bg-white hover:bg-gray-100 border-2 border-gray-200 rounded-xl py-4 text-2xl font-black text-gray-700 active:scale-95 transition">0</button>
                <button onclick="deletePin()" class="pin-key bg-gray-100 hover:bg-gray-200 border-2 border-gray-200 rounded-xl py-4 text-xl font-black text-gray-500 active:scale-95 transition">â†</button>
            </div>

            <p id="pin-error-msg" class="text-red-400 font-bold mt-4 hidden">ã¡ãŒã†ã¿ãŸã„... ğŸ’¦</p>
        </div>
    </div>

    <!-- â–¼â–¼â–¼ 2. ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ (å¸¸æ™‚è¡¨ç¤º) â–¼â–¼â–¼ -->
    <nav class="bg-white/90 backdrop-blur-md sticky top-0 z-50 px-4 py-3 shadow-lg border-b-4 nav-border flex justify-between items-center">
        <div class="flex items-center gap-2 cursor-pointer select-none" onclick="AppSystem.loadHome()">
            <span class="text-2xl animate-float" id="nav-icon">ğŸ°</span>
            <h1 class="font-black text-lg md:text-xl bg-clip-text text-transparent tracking-wider nav-title">ã‚ãã‚ããƒ©ãƒ³ãƒ‰</h1>
        </div>
        <div class="flex items-center gap-3">
            <div class="star-badge text-white px-4 py-1.5 rounded-full font-black shadow-md flex items-center gap-2 select-none border-2">
                <span class="text-xl animate-twinkle">â­</span>
                <span id="star-count" class="text-xl">0</span>
            </div>
            <button id="parent-btn" class="text-gray-400 hover:text-gray-600 text-sm font-bold px-2 py-1 rounded transition select-none" title="ä¿è­·è€…ç”¨ï¼ˆé•·æŠ¼ã—ã§ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ï¼‰">
                ğŸ‘¤
            </button>
        </div>
    </nav>

    <!-- â–¼â–¼â–¼ 3. ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ (ã“ã“ã«ã‚¢ãƒ—ãƒªã‚„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹) â–¼â–¼â–¼ -->
    <main id="app-container" class="flex-1 overflow-y-auto relative scroll-smooth">
        <!-- åˆæœŸãƒ­ãƒ¼ãƒ‰ä¸­ã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„ã‹ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤º -->
    </main>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, getDocs, query, where, onSnapshot, orderBy, updateDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCcM38mjkSVXJDFJaxqZ8PXCuLr-bwNfsU",
            authDomain: "family-app-1006.firebaseapp.com",
            projectId: "family-app-1006",
            storageBucket: "family-app-1006.firebasestorage.app",
            messagingSenderId: "516894951381",
            appId: "1:516894951381:web:76d0b88cb8c406d6791f5c"
        };

        const firebaseApp = initializeApp(firebaseConfig, 'main-app');
        const db = getFirestore(firebaseApp);

        // === ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† ===
        window.getCurrentChild = () => {
            const stored = sessionStorage.getItem('currentChild');
            return stored ? JSON.parse(stored) : null;
        };

        window.setCurrentChild = (child) => {
            if (child) {
                sessionStorage.setItem('currentChild', JSON.stringify(child));
            } else {
                sessionStorage.removeItem('currentChild');
            }
        };

        // === å­ä¾›ä¸€è¦§ã‚’å–å¾— ===
        window.loadChildren = async () => {
            try {
                const q = query(
                    collection(db, 'children'),
                    where('isActive', '==', true),
                    orderBy('createdAt', 'asc')
                );
                const snapshot = await getDocs(q);
                return snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (e) {
                console.error('å­ä¾›ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
                return [];
            }
        };

        // === å­ä¾›ã®PINã‚’æ¤œè¨¼ ===
        window.verifyChildPin = async (childId, pin) => {
            try {
                const docRef = doc(db, 'children', childId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data().pin === pin;
                }
                return false;
            } catch (e) {
                console.error('PINæ¤œè¨¼ã‚¨ãƒ©ãƒ¼:', e);
                return false;
            }
        };

        // === å­ä¾›ã‚’è¿½åŠ  ===
        window.addChild = async (name, pin, avatarEmoji) => {
            try {
                const docRef = await addDoc(collection(db, 'children'), {
                    name: name,
                    pin: pin,
                    avatarEmoji: avatarEmoji,
                    isActive: true,
                    createdAt: serverTimestamp()
                });
                return docRef.id;
            } catch (e) {
                console.error('å­ä¾›è¿½åŠ ã‚¨ãƒ©ãƒ¼:', e);
                return null;
            }
        };

        // === åˆå›èµ·å‹•æ™‚ã«ã€Œã‹ã‚Šã‚“ã€ã‚’è‡ªå‹•ä½œæˆ & æ—¢å­˜ãƒ­ã‚°ã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ===
        window.ensureDefaultChild = async () => {
            try {
                // å­ä¾›ä¸€è¦§ã‚’å–å¾—
                const children = await window.loadChildren();

                // æ—¢ã«å­ä¾›ãŒã„ã‚Œã°ä½•ã‚‚ã—ãªã„
                if (children.length > 0) {
                    return children;
                }

                // ã€Œã‹ã‚Šã‚“ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ
                console.log('åˆå›èµ·å‹•: ã‹ã‚Šã‚“ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆä¸­...');
                const karinId = await window.addChild('ã‹ã‚Šã‚“', '1234', 'ğŸ‘§');

                if (karinId) {
                    // æ—¢å­˜ãƒ­ã‚°ã‚’ã‹ã‚Šã‚“ã«ç´ã¥ã‘ï¼ˆãƒãƒƒãƒå‡¦ç†ï¼‰
                    await migrateOldLogs(karinId, 'ã‹ã‚Šã‚“');
                    console.log('ã‹ã‚Šã‚“ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆå®Œäº†');
                }

                // æ›´æ–°ã•ã‚ŒãŸå­ä¾›ä¸€è¦§ã‚’è¿”ã™
                return await window.loadChildren();
            } catch (e) {
                console.error('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå­ä¾›ä½œæˆã‚¨ãƒ©ãƒ¼:', e);
                return [];
            }
        };

        // æ—¢å­˜ãƒ­ã‚°ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        async function migrateOldLogs(childId, childName) {
            try {
                // app_usage_logs ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                const usageQuery = query(collection(db, 'app_usage_logs'));
                const usageSnapshot = await getDocs(usageQuery);

                const batch1 = writeBatch(db);
                let count1 = 0;
                usageSnapshot.docs.forEach(docSnap => {
                    const data = docSnap.data();
                    if (!data.childId) {
                        batch1.update(doc(db, 'app_usage_logs', docSnap.id), {
                            childId: childId,
                            childName: childName
                        });
                        count1++;
                    }
                });
                if (count1 > 0) {
                    await batch1.commit();
                    console.log(`app_usage_logs: ${count1}ä»¶ã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³`);
                }

                // quiz_logs ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                const quizQuery = query(collection(db, 'quiz_logs'));
                const quizSnapshot = await getDocs(quizQuery);

                const batch2 = writeBatch(db);
                let count2 = 0;
                quizSnapshot.docs.forEach(docSnap => {
                    const data = docSnap.data();
                    if (!data.childId) {
                        batch2.update(doc(db, 'quiz_logs', docSnap.id), {
                            childId: childId,
                            childName: childName
                        });
                        count2++;
                    }
                });
                if (count2 > 0) {
                    await batch2.commit();
                    console.log(`quiz_logs: ${count2}ä»¶ã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³`);
                }
            } catch (e) {
                console.error('ãƒ­ã‚°ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', e);
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆchildIdå¯¾å¿œï¼‰
        window.logAppUsage = async (appTitle, appFile) => {
            try {
                const currentChild = window.getCurrentChild();
                await addDoc(collection(db, 'app_usage_logs'), {
                    appTitle,
                    appFile,
                    date: getTodayString(),
                    timestamp: serverTimestamp(),
                    childId: currentChild?.id || null,
                    childName: currentChild?.name || null
                });
            } catch (e) {
                console.error('ä½¿ç”¨ãƒ­ã‚°è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', e);
            }
        };

        window.logQuizResult = async (appTitle, question, isCorrect, details = {}) => {
            try {
                const currentChild = window.getCurrentChild();
                await addDoc(collection(db, 'quiz_logs'), {
                    appTitle,
                    question,
                    isCorrect,
                    details,
                    date: getTodayString(),
                    timestamp: serverTimestamp(),
                    childId: currentChild?.id || null,
                    childName: currentChild?.name || null
                });
            } catch (e) {
                console.error('ã‚¯ã‚¤ã‚ºãƒ­ã‚°è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', e);
            }
        };

        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
        function getTodayString() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }
        window.getTodayString = getTodayString;

        // è¡¨ç¤ºã™ã‚‹ã‚¢ãƒ—ãƒªIDã‚’å–å¾—
        window.getVisibleAppIds = async () => {
            try {
                const docRef = doc(db, 'settings', 'visible_apps');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data().appIds || null;
                }
                return null; // è¨­å®šãŒãªã„å ´åˆã¯å…¨è¡¨ç¤º
            } catch (e) {
                console.error('è¡¨ç¤ºè¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
                return null;
            }
        };

        // ãƒ†ãƒ¼ãƒè¨­å®šã‚’å–å¾—
        window.getThemeSetting = async () => {
            try {
                const docRef = doc(db, 'settings', 'theme');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data().theme || 'cute';
                }
                return 'cute'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            } catch (e) {
                console.error('ãƒ†ãƒ¼ãƒè¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
                return 'cute';
            }
        };

        // ãƒ†ãƒ¼ãƒã‚’é©ç”¨ï¼ˆèµ·å‹•æ™‚ã«å‘¼ã³å‡ºã—ï¼‰
        window.applyTheme = (themeName) => {
            const body = document.body;
            body.classList.remove('theme-cute', 'theme-cool', 'theme-smart');
            body.classList.add(`theme-${themeName}`);

            // ãƒŠãƒ“ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
            const navIcon = document.getElementById('nav-icon');
            const lockIcon = document.getElementById('lock-icon');
            const icons = { cute: 'ğŸ°', cool: 'ğŸš€', smart: 'ğŸ“±' };
            if (navIcon) navIcon.textContent = icons[themeName] || 'ğŸ°';
            if (lockIcon) lockIcon.textContent = icons[themeName] || 'ğŸ°';

            // ãƒ­ãƒƒã‚¯ç”»é¢ã®è£…é£¾ã‚’æ›´æ–°
            updateLockDecorations(themeName);
        };

        // ãƒ­ãƒƒã‚¯ç”»é¢ã®è£…é£¾ã‚’æ›´æ–°
        function updateLockDecorations(themeName) {
            const container = document.getElementById('lock-decorations');
            if (!container) return;

            const decorations = {
                cute: ['â­', 'ğŸŒ¸', 'ğŸ’–', 'âœ¨', 'ğŸ¦‹', 'ğŸŒˆ'],
                cool: ['ğŸš€', 'ğŸ¦–', 'âš¡', 'ğŸ®', 'ğŸ”¥', 'ğŸ’¥'],
                smart: ['â—†', 'â—‹', 'â–¡', 'â–³', 'â—', 'â—‡']
            };

            const items = decorations[themeName] || decorations.cute;
            const positions = [
                { top: '10%', left: '10%' },
                { top: '20%', right: '15%' },
                { top: '60%', left: '5%' },
                { top: '70%', right: '10%' },
                { top: '40%', right: '20%' },
                { top: '80%', left: '20%' }
            ];

            container.innerHTML = positions.map((pos, i) => `
                <span class="absolute text-${i % 2 === 0 ? '4xl' : '3xl'} animate-float${i % 2 === 1 ? '-delay' : ''} ${themeName === 'smart' ? 'text-gray-400' : ''}"
                      style="top: ${pos.top}; ${pos.left ? 'left: ' + pos.left : 'right: ' + pos.right};">
                    ${items[i % items.length]}
                </span>
            `).join('');
        }

        // èµ·å‹•æ™‚ã«ãƒ†ãƒ¼ãƒã‚’èª­ã¿è¾¼ã¿
        window.initTheme = async () => {
            const theme = await window.getThemeSetting();
            window.applyTheme(theme);
        };
        window.initTheme();

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šçŸ¥: æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
        window.messageUnreadCount = 0;
        window.messageUnsubscribe = null;

        window.startMessageListener = () => {
            if (window.messageUnsubscribe) return; // æ—¢ã«ç›£è¦–ä¸­

            const q = query(
                collection(db, 'family_messages'),
                where('to', '==', 'child'),
                where('read', '==', false)
            );

            window.messageUnsubscribe = onSnapshot(q, (snapshot) => {
                window.messageUnreadCount = snapshot.size;
                // ãƒãƒƒã‚¸æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
                window.dispatchEvent(new CustomEvent('messageCountUpdate', {
                    detail: { count: snapshot.size }
                }));
            }, (error) => {
                console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç›£è¦–ã‚¨ãƒ©ãƒ¼:', error);
            });
        };

        window.stopMessageListener = () => {
            if (window.messageUnsubscribe) {
                window.messageUnsubscribe();
                window.messageUnsubscribe = null;
            }
        };

        // FirebaseåˆæœŸåŒ–å®Œäº†å¾Œã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’åˆæœŸåŒ–
        if (window.initLoginScreen) {
            window.initLoginScreen();
        }
    </script>

    <!-- â–¼â–¼â–¼ 4. ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼ -->
    <script>
        // --- å­ä¾›é¸æŠãƒ»PINå…¥åŠ›ç®¡ç† ---
        let selectedChild = null;
        let enteredPin = '';
        let childrenList = [];

        // --- æ—¥ä»˜ãƒ»å­ä¾›ã”ã¨ã®ã‚¹ã‚¿ãƒ¼ç®¡ç† ---
        const getStarKey = () => {
            const date = window.getTodayString ? window.getTodayString() : new Date().toISOString().split('T')[0];
            const currentChild = window.getCurrentChild ? window.getCurrentChild() : null;
            const childId = currentChild?.id || 'guest';
            return `kids_stars_${childId}_${date}`;
        };

        // --- ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ---
        // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ã®ã‚’å¾…ã¤
        window.initLoginScreen = () => {
            loadChildrenList();
        };

        // å­ä¾›ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤ºï¼ˆåˆå›èµ·å‹•æ™‚ã¯ã€Œã‹ã‚Šã‚“ã€ã‚’è‡ªå‹•ä½œæˆï¼‰
        async function loadChildrenList() {
            if (window.ensureDefaultChild) {
                childrenList = await window.ensureDefaultChild();
            } else if (window.loadChildren) {
                childrenList = await window.loadChildren();
            }
            renderChildrenGrid();
            initAvatarPicker();
        }

        // å­ä¾›ä¸€è¦§ã‚’ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º
        function renderChildrenGrid() {
            const grid = document.getElementById('children-grid');
            if (!grid) return;

            if (childrenList.length === 0) {
                grid.innerHTML = `
                    <div class="text-gray-500 col-span-2 py-8 text-center">
                        <div class="text-4xl mb-2">ğŸ‘¶</div>
                        <p class="font-bold text-sm">ã¾ã  ã ã‚Œã‚‚ ã„ãªã„ã‚ˆ</p>
                        <p class="text-xs mt-1 opacity-70">ã€Œã¤ã„ã‹ã€ãƒœã‚¿ãƒ³ã§ ã¤ã„ã‹ã—ã¦ã­</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = childrenList.map(child => `
                <div class="child-card text-center" onclick="selectChild('${child.id}')">
                    <div class="text-4xl mb-2">${child.avatarEmoji || 'ğŸ‘¤'}</div>
                    <p class="font-black text-gray-700">${child.name}</p>
                </div>
            `).join('');
        }

        // å­ä¾›ã‚’é¸æŠã—ã¦PINç”»é¢ã¸
        function selectChild(childId) {
            selectedChild = childrenList.find(c => c.id === childId);
            if (!selectedChild) return;

            // UIæ›´æ–°
            document.getElementById('selected-child-avatar').textContent = selectedChild.avatarEmoji || 'ğŸ‘¤';
            document.getElementById('selected-child-name').textContent = selectedChild.name;

            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('child-select-screen').classList.add('hidden');
            document.getElementById('pin-input-screen').classList.remove('hidden');

            // PINåˆæœŸåŒ–
            clearPin();
        }

        // å­ä¾›é¸æŠç”»é¢ã«æˆ»ã‚‹
        function backToChildSelect() {
            document.getElementById('pin-input-screen').classList.add('hidden');
            document.getElementById('child-select-screen').classList.remove('hidden');
            selectedChild = null;
            clearPin();
        }

        // PINå…¥åŠ›
        function enterPin(digit) {
            if (enteredPin.length >= 4) return;
            enteredPin += digit;
            updatePinDots();

            // 4æ¡å…¥åŠ›å®Œäº†
            if (enteredPin.length === 4) {
                verifyPin();
            }
        }

        // PINä¸€æ–‡å­—å‰Šé™¤
        function deletePin() {
            enteredPin = enteredPin.slice(0, -1);
            updatePinDots();
        }

        // PINã‚¯ãƒªã‚¢
        function clearPin() {
            enteredPin = '';
            updatePinDots();
            document.getElementById('pin-error-msg')?.classList.add('hidden');
        }

        // PINãƒ‰ãƒƒãƒˆè¡¨ç¤ºæ›´æ–°
        function updatePinDots() {
            const dots = document.querySelectorAll('.pin-dot');
            dots.forEach((dot, i) => {
                if (i < enteredPin.length) {
                    dot.classList.add('filled');
                } else {
                    dot.classList.remove('filled');
                }
            });
        }

        // PINæ¤œè¨¼
        async function verifyPin() {
            if (!selectedChild) return;

            const isValid = await window.verifyChildPin(selectedChild.id, enteredPin);

            if (isValid) {
                // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
                window.setCurrentChild(selectedChild);
                unlockApp();
            } else {
                // ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—
                const errorMsg = document.getElementById('pin-error-msg');
                errorMsg.classList.remove('hidden');

                // ã‚·ã‚§ã‚¤ã‚¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                const pinScreen = document.getElementById('pin-input-screen');
                pinScreen.classList.remove('animate-shake');
                void pinScreen.offsetWidth;
                pinScreen.classList.add('animate-shake');

                // PINã‚¯ãƒªã‚¢
                setTimeout(() => {
                    clearPin();
                }, 500);
            }
        }

        // ã‚¢ãƒã‚¿ãƒ¼é¸æŠè‚¢
        const avatarEmojis = ['ğŸ‘§', 'ğŸ‘¦', 'ğŸ‘¶', 'ğŸ§’', 'ğŸ‘¸', 'ğŸ¤´', 'ğŸ¦¸', 'ğŸ¦¹', 'ğŸ±', 'ğŸ¶', 'ğŸ°', 'ğŸ¦Š', 'ğŸ¼', 'ğŸ¨', 'ğŸ¦', 'ğŸ¯'];
        let selectedAvatar = 'ğŸ‘§';

        // ã‚¢ãƒã‚¿ãƒ¼é¸æŠUIã‚’åˆæœŸåŒ–
        function initAvatarPicker() {
            const picker = document.getElementById('avatar-picker');
            if (!picker) return;

            picker.innerHTML = avatarEmojis.map(emoji => `
                <button type="button" onclick="selectAvatar('${emoji}')"
                    class="avatar-pick-btn w-10 h-10 text-2xl rounded-lg border-2 transition ${emoji === selectedAvatar ? 'border-pink-400 bg-pink-100' : 'border-gray-200 hover:border-pink-200'}">
                    ${emoji}
                </button>
            `).join('');
        }

        // ã‚¢ãƒã‚¿ãƒ¼é¸æŠ
        function selectAvatar(emoji) {
            selectedAvatar = emoji;
            document.getElementById('new-child-avatar').value = emoji;
            document.getElementById('new-child-avatar-preview').textContent = emoji;

            // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.avatar-pick-btn').forEach(btn => {
                if (btn.textContent.trim() === emoji) {
                    btn.classList.remove('border-gray-200');
                    btn.classList.add('border-pink-400', 'bg-pink-100');
                } else {
                    btn.classList.remove('border-pink-400', 'bg-pink-100');
                    btn.classList.add('border-gray-200');
                }
            });
        }

        // å­ä¾›è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
        function showAddChildForm() {
            document.getElementById('child-select-screen').classList.add('hidden');
            document.getElementById('add-child-screen').classList.remove('hidden');

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('new-child-name').value = '';
            document.getElementById('new-child-pin').value = '';
            selectedAvatar = 'ğŸ‘§';
            document.getElementById('new-child-avatar').value = 'ğŸ‘§';
            document.getElementById('new-child-avatar-preview').textContent = 'ğŸ‘§';
            document.getElementById('add-child-error').classList.add('hidden');
            initAvatarPicker();
        }

        // å­ä¾›è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤º
        function hideAddChildForm() {
            document.getElementById('add-child-screen').classList.add('hidden');
            document.getElementById('child-select-screen').classList.remove('hidden');
        }

        // æ–°ã—ã„å­ä¾›ã‚’ä¿å­˜
        async function saveNewChild() {
            const name = document.getElementById('new-child-name').value.trim();
            const pin = document.getElementById('new-child-pin').value.trim();
            const avatar = document.getElementById('new-child-avatar').value;
            const errorEl = document.getElementById('add-child-error');
            const saveBtn = document.getElementById('save-child-btn');

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!name) {
                errorEl.textContent = 'ãªã¾ãˆã‚’ ã„ã‚Œã¦ã­';
                errorEl.classList.remove('hidden');
                return;
            }
            if (!pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                errorEl.textContent = 'PINã¯ 4ã‘ãŸã® ã™ã†ã˜ã§ ã„ã‚Œã¦ã­';
                errorEl.classList.remove('hidden');
                return;
            }

            // ä¿å­˜ä¸­
            saveBtn.textContent = 'ã¤ã„ã‹ã¡ã‚…ã†...';
            saveBtn.disabled = true;

            try {
                const newId = await window.addChild(name, pin, avatar);
                if (newId) {
                    // æˆåŠŸ - å­ä¾›ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦é¸æŠç”»é¢ã«æˆ»ã‚‹
                    childrenList = await window.loadChildren();
                    renderChildrenGrid();
                    hideAddChildForm();
                } else {
                    errorEl.textContent = 'ã¤ã„ã‹ã§ãã¾ã›ã‚“ã§ã—ãŸ';
                    errorEl.classList.remove('hidden');
                }
            } catch (e) {
                errorEl.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒãŠãã¾ã—ãŸ';
                errorEl.classList.remove('hidden');
            }

            saveBtn.textContent = 'âœ¨ ã¤ã„ã‹ï¼';
            saveBtn.disabled = false;
        }

        function unlockApp() {
            const ls = document.getElementById('login-screen');
            ls.style.transition = "opacity 0.5s ease";
            ls.style.opacity = "0";
            // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå¾Œã«ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•
            setTimeout(()=>{
                ls.style.display="none";
                AppSystem.init();
            }, 500);
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        window.addEventListener('messageCountUpdate', (e) => {
            AppSystem.updateMessageBadge();
        });

        // ä¿è­·è€…ãƒœã‚¿ãƒ³é•·æŠ¼ã—æ¤œçŸ¥
        let parentBtnPressTimer = null;
        let parentBtnIsLongPress = false;

        function setupParentButtonLongPress() {
            const parentBtn = document.getElementById('parent-btn');
            if (!parentBtn) return;

            const startPress = (e) => {
                e.preventDefault();
                parentBtnIsLongPress = false;
                parentBtnPressTimer = setTimeout(() => {
                    parentBtnIsLongPress = true;
                    // é•·æŠ¼ã—æˆåŠŸ - ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
                    AppSystem.launchApp('parent_v1.js', 'ã»ã”ã—ã‚ƒã‚ˆã†', { adminMode: true });
                }, 3000); // 3ç§’é•·æŠ¼ã—
            };

            const endPress = (e) => {
                clearTimeout(parentBtnPressTimer);
                if (!parentBtnIsLongPress) {
                    // çŸ­æŠ¼ã— - é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
                    AppSystem.launchApp('parent_v1.js', 'ã»ã”ã—ã‚ƒã‚ˆã†', { adminMode: false });
                }
            };

            const cancelPress = () => {
                clearTimeout(parentBtnPressTimer);
            };

            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
            parentBtn.addEventListener('touchstart', startPress, { passive: false });
            parentBtn.addEventListener('touchend', endPress);
            parentBtn.addEventListener('touchcancel', cancelPress);

            // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
            parentBtn.addEventListener('mousedown', startPress);
            parentBtn.addEventListener('mouseup', endPress);
            parentBtn.addEventListener('mouseleave', cancelPress);
        }

        // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ  ---
        const AppSystem = {
            registry: [],
            visibleAppIds: null,
            currentAppCleanup: null,
            currentTheme: 'cute',

            // ãƒ†ãƒ¼ãƒè¨­å®šã‚’å–å¾—
            getThemeConfig() {
                const theme = this.currentTheme || 'cute';
                const configs = {
                    cute: {
                        icon: 'ğŸ°',
                        decorations: ['ğŸŒ¸', 'ğŸ’–', 'âœ¨', 'ğŸ¦‹', 'ğŸŒˆ', 'â­'],
                        floatingDecorations: ['â­', 'ğŸ’–', 'ğŸŒ¸', 'âœ¨', 'ğŸ¦‹', 'ğŸŒˆ', 'ğŸ’«', 'ğŸ€', 'ğŸ’•', 'ğŸŒŸ'],
                        bgGradient: 'bg-gradient-to-b from-pink-50/80 via-purple-50/80 to-blue-50/80',
                        titleGradient: 'bg-gradient-to-r from-pink-400 via-purple-400 to-blue-400',
                        cardClass: 'bg-white/90 border-white hover:border-pink-200',
                        cardHoverBg: 'bg-gradient-to-b from-pink-100/50 to-purple-100/50',
                        cardTextColor: 'text-gray-700',
                        cardSubTextColor: 'text-gray-500',
                        buttonGradient: 'bg-gradient-to-r from-pink-400 to-purple-400 hover:from-pink-500 hover:to-purple-500',
                        footerColor: 'text-pink-300',
                        footerIcon: 'âœ¨',
                        decoClass: ''
                    },
                    cool: {
                        icon: 'ğŸš€',
                        decorations: ['ğŸš€', 'ğŸ¦–', 'âš¡', 'ğŸ®', 'ğŸ”¥', 'ğŸ’¥'],
                        floatingDecorations: ['ğŸš€', 'ğŸ¦–', 'âš¡', 'ğŸ®', 'ğŸ”¥', 'ğŸ’¥', 'â­', 'ğŸï¸', 'ğŸ¦¸', 'ğŸŒŸ'],
                        bgGradient: 'bg-gradient-to-b from-slate-900/90 via-cyan-900/80 to-teal-900/80',
                        titleGradient: 'bg-gradient-to-r from-cyan-400 via-emerald-400 to-yellow-400',
                        cardClass: 'bg-slate-800/90 border-slate-700 hover:border-cyan-400',
                        cardHoverBg: 'bg-gradient-to-b from-cyan-500/20 to-emerald-500/20',
                        cardTextColor: 'text-white',
                        cardSubTextColor: 'text-gray-300',
                        buttonGradient: 'bg-gradient-to-r from-cyan-500 to-emerald-500 hover:from-cyan-400 hover:to-emerald-400',
                        footerColor: 'text-cyan-400',
                        footerIcon: 'ğŸš€',
                        decoClass: ''
                    },
                    smart: {
                        icon: 'ğŸ“±',
                        decorations: ['â—†', 'â—‹', 'â–¡', 'â–³', 'â—', 'â—‡'],
                        floatingDecorations: ['â—†', 'â—‹', 'â–¡', 'â–³', 'â—', 'â—‡', 'â–ª', 'â–«', 'â—ˆ', 'â—‰'],
                        bgGradient: 'bg-gradient-to-b from-slate-100/90 via-gray-100/80 to-slate-200/80',
                        titleGradient: 'bg-gradient-to-r from-slate-600 via-gray-500 to-slate-600',
                        cardClass: 'bg-white/95 border-slate-200 hover:border-slate-400',
                        cardHoverBg: 'bg-gradient-to-b from-slate-100/50 to-gray-100/50',
                        cardTextColor: 'text-slate-700',
                        cardSubTextColor: 'text-slate-500',
                        buttonGradient: 'bg-gradient-to-r from-slate-600 to-gray-600 hover:from-slate-500 hover:to-gray-500',
                        footerColor: 'text-slate-400',
                        footerIcon: 'â—†',
                        decoClass: 'text-slate-400'
                    }
                };
                return configs[theme] || configs.cute;
            },

            // åˆæœŸåŒ–: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            async init() {
                this.updateStars();
                this.updateCurrentChildDisplay();

                // ä¿è­·è€…ãƒœã‚¿ãƒ³ã®é•·æŠ¼ã—æ¤œçŸ¥ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
                setupParentButtonLongPress();

                try {
                    // ãƒ†ãƒ¼ãƒè¨­å®šã‚’å–å¾—ã—ã¦é©ç”¨
                    if (window.getThemeSetting) {
                        this.currentTheme = await window.getThemeSetting();
                        window.applyTheme(this.currentTheme);
                    }

                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãã§å–å¾—
                    const res = await fetch(`./apps/registry.json?t=${Date.now()}`);
                    if(!res.ok) throw new Error("File not found");
                    this.registry = await res.json();

                    // è¡¨ç¤ºè¨­å®šã‚’å–å¾—
                    if (window.getVisibleAppIds) {
                        this.visibleAppIds = await window.getVisibleAppIds();
                    }

                    this.loadHome();
                } catch(e) {
                    console.error(e);
                    document.getElementById('app-container').innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-white text-center p-4">
                            <div class="text-6xl mb-4">ğŸ˜¢</div>
                            <p class="font-bold text-xl">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«ã—ã£ã±ã„ã—ãŸã‚ˆ</p>
                            <p class="text-sm mt-2 opacity-80">ãƒ‘ã‚½ã‚³ãƒ³ã®è¨­å®šã‚’ç¢ºèªã—ã¦ã­</p>
                            <p class="text-xs mt-4 opacity-50 font-mono">${e.message}</p>
                        </div>`;
                }
            },

            // ãƒ›ãƒ¼ãƒ ç”»é¢ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ã®æç”»
            async loadHome() {
                // å‰ã®ã‚¢ãƒ—ãƒªã®å¾Œç‰‡ä»˜ã‘
                if(this.currentAppCleanup) {
                    this.currentAppCleanup();
                    this.currentAppCleanup = null;
                }

                // è¡¨ç¤ºè¨­å®šã‚’å†èª­ã¿è¾¼ã¿
                if (window.getVisibleAppIds) {
                    this.visibleAppIds = await window.getVisibleAppIds();
                }
                
                // ã‚«ãƒ¼ãƒ‰ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
                const renderCards = (apps, colorTheme) => {
                    if(apps.length === 0) return '<div class="col-span-full text-gray-400 font-bold p-8 text-center bg-white/50 rounded-xl">ã¾ã  ã‚¢ãƒ—ãƒªãŒãªã„ã‚ˆ ğŸš§</div>';
                    
                    return apps.map(app => `
                    <div onclick="AppSystem.launchApp('${app.file}', '${app.title}')" 
                         class="bg-white rounded-3xl p-6 shadow-lg border-b-8 border-${app.color} flex flex-col items-center cursor-pointer transform transition-all duration-200 hover:scale-105 hover:-translate-y-1 active:scale-95 group relative overflow-hidden">
                        
                        <!-- èƒŒæ™¯ã®ã‚­ãƒ©ã‚­ãƒ©è£…é£¾ï¼ˆãƒ›ãƒãƒ¼æ™‚ï¼‰ -->
                        <div class="absolute inset-0 bg-gradient-to-b from-transparent to-${app.color}/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        
                        <div class="bg-${app.color.split('-')[0]}-50 w-24 h-24 rounded-full flex items-center justify-center text-5xl mb-4 group-hover:scale-110 group-hover:rotate-12 transition-transform duration-300 shadow-inner z-10">
                            ${app.icon}
                        </div>
                        <h4 class="text-xl font-black text-gray-700 mb-1 z-10 text-center leading-tight">${app.title}</h4>
                        <p class="text-sm text-gray-500 font-bold opacity-70 mb-4 z-10 text-center">${app.desc}</p>
                        
                        <div class="mt-auto bg-${app.color} text-white font-bold py-2 px-8 rounded-full text-sm shadow-md group-hover:shadow-lg z-10">
                            ã‚ãã¶ï¼
                        </div>
                    </div>`).join('');
                };

                // è¡¨ç¤ºè¨­å®šã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const allApps = this.visibleAppIds
                    ? this.registry.filter(app => this.visibleAppIds.includes(app.id))
                    : this.registry;

                // ãƒ†ãƒ¼ãƒåˆ¥ã®è¨­å®š
                const themeConfig = this.getThemeConfig();

                document.getElementById('app-container').innerHTML = `
                    <!-- æµ®ã‹ã¶è£…é£¾ï¼ˆãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸å°‚ç”¨ï¼‰ -->
                    <div class="floating-decorations" id="floating-deco"></div>

                    <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
                    <div class="min-h-full ${themeConfig.bgGradient} pt-6 px-4 pb-8 relative z-20">
                        <!-- è£…é£¾ -->
                        <div class="absolute top-4 left-4 text-3xl opacity-40 animate-float ${themeConfig.decoClass}">${themeConfig.decorations[0]}</div>
                        <div class="absolute top-8 right-8 text-3xl opacity-40 animate-float-delay ${themeConfig.decoClass}">${themeConfig.decorations[1]}</div>
                        <div class="absolute top-1/4 left-8 text-2xl opacity-30 animate-float ${themeConfig.decoClass}">${themeConfig.decorations[2]}</div>
                        <div class="absolute top-1/3 right-4 text-2xl opacity-30 animate-float-delay ${themeConfig.decoClass}">${themeConfig.decorations[3]}</div>
                        <div class="absolute bottom-1/4 left-4 text-2xl opacity-30 animate-float ${themeConfig.decoClass}">${themeConfig.decorations[4]}</div>
                        <div class="absolute bottom-1/3 right-8 text-2xl opacity-30 animate-float-delay ${themeConfig.decoClass}">${themeConfig.decorations[5]}</div>

                        <div class="max-w-5xl mx-auto relative z-10">
                            <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
                            <div class="text-center mb-8">
                                <div class="flex items-center justify-center gap-3 mb-2">
                                    <span class="text-4xl animate-float">${themeConfig.icon}</span>
                                    <h2 class="text-3xl md:text-4xl font-black bg-clip-text text-transparent ${themeConfig.titleGradient}">
                                        ãªã«ã—ã¦ ã‚ãã¶ï¼Ÿ
                                    </h2>
                                    <span class="text-4xl animate-float-delay">${themeConfig.decorations[2]}</span>
                                </div>
                            </div>

                            <!-- ã‚¢ãƒ—ãƒªä¸€è¦§ -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                                ${allApps.length === 0 ? '<div class="col-span-full text-gray-400 font-bold p-8 text-center bg-white/50 rounded-xl">ã¾ã  ã‚¢ãƒ—ãƒªãŒãªã„ã‚ˆ ğŸš§</div>' : allApps.map(app => `
                                    <div onclick="AppSystem.launchApp('${app.file}', '${app.title}')"
                                         class="${themeConfig.cardClass} backdrop-blur rounded-3xl p-6 shadow-lg border-4 flex flex-col items-center cursor-pointer transform transition-all duration-200 hover:scale-105 hover:-translate-y-2 active:scale-95 group relative overflow-hidden"
                                         data-app-id="${app.id}">

                                        <!-- é€šçŸ¥ãƒãƒƒã‚¸ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ãƒ—ãƒªç”¨ï¼‰ -->
                                        ${app.id === 'family_message_01' ? '<div id="message-badge" class="absolute top-2 right-2 bg-red-500 text-white text-sm font-black w-7 h-7 rounded-full flex items-center justify-center shadow-lg z-20 hidden animate-bounce">0</div>' : ''}

                                        <!-- èƒŒæ™¯ã®ã‚­ãƒ©ã‚­ãƒ©è£…é£¾ï¼ˆãƒ›ãƒãƒ¼æ™‚ï¼‰ -->
                                        <div class="absolute inset-0 ${themeConfig.cardHoverBg} opacity-0 group-hover:opacity-100 transition-opacity"></div>

                                        <div class="bg-gradient-to-br from-${app.color.split('-')[0]}-100 to-${app.color.split('-')[0]}-200 w-24 h-24 rounded-full flex items-center justify-center text-5xl mb-4 group-hover:scale-110 group-hover:rotate-12 transition-transform duration-300 shadow-lg z-10 border-4 border-white">
                                            ${app.icon}
                                        </div>
                                        <h4 class="text-xl font-black ${themeConfig.cardTextColor} mb-1 z-10 text-center leading-tight">${app.title}</h4>
                                        <p class="text-sm ${themeConfig.cardSubTextColor} font-bold opacity-70 mb-4 z-10 text-center">${app.desc}</p>

                                        <div class="mt-auto ${themeConfig.buttonGradient} text-white font-bold py-2 px-8 rounded-full text-sm shadow-md group-hover:shadow-lg z-10 transition-all">
                                            ã‚ãã¶ï¼
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
                        <footer class="text-center py-8 ${themeConfig.footerColor} text-xs font-bold">
                            ${themeConfig.footerIcon} ã‚ãã‚ããƒ©ãƒ³ãƒ‰ ${themeConfig.footerIcon}
                        </footer>
                    </div>
                `;

                // æµ®ã‹ã¶è£…é£¾ã‚’ç”Ÿæˆ
                createFloatingDecorations();

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šçŸ¥ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹
                if (window.startMessageListener) {
                    window.startMessageListener();
                }

                // ãƒãƒƒã‚¸ã‚’æ›´æ–°
                this.updateMessageBadge();
            },

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒƒã‚¸æ›´æ–°
            updateMessageBadge() {
                const badge = document.getElementById('message-badge');
                if (badge) {
                    const count = window.messageUnreadCount || 0;
                    if (count > 0) {
                        badge.textContent = count > 99 ? '99+' : count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            },

            // ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®å­ä¾›ã‚’è¡¨ç¤º
            updateCurrentChildDisplay() {
                const currentChild = window.getCurrentChild ? window.getCurrentChild() : null;
                const parentBtn = document.getElementById('parent-btn');
                if (parentBtn && currentChild) {
                    parentBtn.innerHTML = `<span class="text-lg">${currentChild.avatarEmoji || 'ğŸ‘¤'}</span>`;
                    parentBtn.title = `${currentChild.name} ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼ˆé•·æŠ¼ã—ã§ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ï¼‰`;
                }
            },

            // ã‚¢ãƒ—ãƒªèµ·å‹•å‡¦ç†
            async launchApp(filename, title, options = {}) {
                const container = document.getElementById('app-container');
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢
                container.innerHTML = `
                    <div class="h-full min-h-[80vh] bg-white flex flex-col items-center justify-center font-bold text-gray-400 animate-pulse">
                        <div class="text-6xl mb-4 animate-spin-slow">ğŸ¡</div>
                        <p class="text-xl text-blue-400">ã˜ã‚…ã‚“ã³ã—ã¦ã„ã‚‹ã‚ˆ...</p>
                        <p class="text-sm mt-2 opacity-50">${title}</p>
                    </div>`;
                
                try {
                    // å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    const module = await import(`./apps/${filename}?t=${Date.now()}`);
                    
                    // ç”»é¢ã‚¯ãƒªã‚¢ï¼†ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ
                    container.innerHTML = '';
                    const appRoot = document.createElement('div');
                    // å…¨ç”»é¢ãƒ•ã‚£ãƒƒãƒˆã•ã›ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«
                    appRoot.className = "w-full h-full min-h-[calc(100vh-80px)] bg-white md:rounded-t-3xl shadow-sm md:p-4 animate-pop overflow-hidden";
                    container.appendChild(appRoot);
                    
                    // ä½¿ç”¨ãƒ­ã‚°ã‚’è¨˜éŒ²
                    if (window.logAppUsage) {
                        window.logAppUsage(title, filename);
                    }

                    // ã‚¢ãƒ—ãƒªå®Ÿè¡Œ
                    this.currentAppCleanup = module.default.launch(appRoot, {
                        addScore: (points) => {
                            const current = parseInt(localStorage.getItem(getStarKey()) || '0');
                            const newScore = current + points;
                            localStorage.setItem(getStarKey(), newScore);
                            this.updateStars();
                        },
                        goHome: () => this.loadHome(),
                        playSound: (type) => console.log('Playing sound:', type),
                        logQuizResult: window.logQuizResult || (() => {}),
                        adminMode: options.adminMode || false,
                        currentChild: window.getCurrentChild ? window.getCurrentChild() : null
                    });

                } catch(e) { 
                    console.error(e);
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å°‘ã—å¾…ã£ã¦ãƒ›ãƒ¼ãƒ ã«æˆ»ã™ï¼ˆä¸€ç¬ã ã¨æ°—ã¥ã‹ãªã„ãŸã‚ï¼‰
                    setTimeout(() => {
                        alert(`ã€Œ${title}ã€ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ã­ã€‚`);
                        this.loadHome(); 
                    }, 500);
                }
            },

            // ã‚¹ã‚¿ãƒ¼è¡¨ç¤ºæ›´æ–°ï¼ˆæ—¥ä»˜ã”ã¨ã«ãƒªã‚»ãƒƒãƒˆï¼‰
            updateStars() {
                const count = localStorage.getItem(getStarKey()) || '0';
                const el = document.getElementById('star-count');
                // æ•°å­—ãŒå¢—ãˆãŸã¨ãã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ä»˜ã‘æ›¿ãˆ
                el.classList.remove('scale-125');
                void el.offsetWidth;
                el.textContent = count;
                el.classList.add('transition', 'transform', 'duration-300', 'scale-125');
                setTimeout(() => el.classList.remove('scale-125'), 300);
            }
        };

        // æµ®ã‹ã¶è£…é£¾ã‚’ç”Ÿæˆï¼ˆãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸å°‚ç”¨ï¼‰
        function createFloatingDecorations() {
            const container = document.getElementById('floating-deco');
            if (!container) return;

            const themeConfig = AppSystem.getThemeConfig();
            const decorations = themeConfig.floatingDecorations;
            const isSmartTheme = AppSystem.currentTheme === 'smart';

            container.innerHTML = ''; // æ—¢å­˜ã®è£…é£¾ã‚’ã‚¯ãƒªã‚¢

            for (let i = 0; i < 15; i++) {
                const span = document.createElement('span');
                span.textContent = decorations[Math.floor(Math.random() * decorations.length)];
                span.style.left = Math.random() * 100 + '%';
                span.style.animationDelay = Math.random() * 15 + 's';
                span.style.animationDuration = (15 + Math.random() * 10) + 's';
                span.style.fontSize = (16 + Math.random() * 16) + 'px';
                if (isSmartTheme) {
                    span.style.color = '#94A3B8';
                    span.style.opacity = '0.3';
                }
                container.appendChild(span);
            }
        }
    </script>
</body>
</html>
