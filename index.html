<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ãã‚ããƒ©ãƒ³ãƒ‰</title>
    <!-- ãƒ•ã‚©ãƒ³ãƒˆ: ãœã‚“ã¾ã‚‹ã‚´ã‚·ãƒƒã‚¯ -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Zen Maru Gothic"', 'sans-serif'] },
                    colors: {
                        sky: { 300: '#7DD3FC', 100: '#E0F2FE' },
                        grass: { 100: '#F0FFF4' },
                        paper: '#FFF5F7'
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'float-delay': 'float 6s ease-in-out 2s infinite',
                        'twinkle': 'twinkle 2s ease-in-out infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'pop': 'pop 0.3s ease-out forwards',
                        'spin-slow': 'spin 3s linear infinite'
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-15px)' } },
                        twinkle: { '0%, 100%': { opacity: '1', transform: 'scale(1)' }, '50%': { opacity: '0.5', transform: 'scale(0.8)' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } },
                        pop: { '0%': { transform: 'scale(0.8)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: "Zen Maru Gothic", sans-serif;
            background: linear-gradient(135deg, #FFE4EC 0%, #E8D5F2 30%, #D4E5F7 60%, #FFE4EC 100%);
            background-attachment: fixed;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        /* æµ®ã‹ã¶è£…é£¾ */
        .floating-decorations {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }
        .floating-decorations span {
            position: absolute;
            font-size: 24px;
            opacity: 0.6;
            animation: floatUp 15s linear infinite;
        }
        @keyframes floatUp {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }
        /* ãƒ­ãƒƒã‚¯ç”»é¢ç”¨ */
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #FFB6C1 0%, #DDA0DD 50%, #87CEEB 100%);
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #lock-screen::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image:
                radial-gradient(circle at 20% 30%, rgba(255,255,255,0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255,255,255,0.2) 0%, transparent 40%);
            pointer-events: none;
        }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼è£…é£¾ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,182,193,0.2); }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #FFB6C1, #DDA0DD); border-radius: 4px; }
        /* è™¹è‰²ãƒœãƒ¼ãƒ€ãƒ¼ */
        .rainbow-border {
            border-image: linear-gradient(90deg, #FF9AA2, #FFB7B2, #FFDAC1, #E2F0CB, #B5EAD7, #C7CEEA) 1;
        }
        /* æ¨ªå‘ãï¼ˆãƒ©ãƒ³ãƒ‰ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰å¯¾å¿œ */
        @media (orientation: landscape) and (max-height: 500px) {
            .landscape\:flex-row { flex-direction: row !important; }
            .landscape\:items-start { align-items: flex-start !important; }
            .landscape\:gap-6 { gap: 1.5rem !important; }
            .landscape\:flex-shrink-0 { flex-shrink: 0 !important; }
            .landscape\:flex-1 { flex: 1 1 0% !important; }
        }
        /* é€šçŸ¥ãƒãƒƒã‚¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes badge-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        #message-badge:not(.hidden) {
            animation: badge-pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800">

    <!-- â–¼â–¼â–¼ 1. ãƒ­ãƒƒã‚¯ç”»é¢ (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£) â–¼â–¼â–¼ -->
    <div id="lock-screen">
        <!-- æµ®ã‹ã¶è£…é£¾ -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <span class="absolute text-4xl animate-float" style="top: 10%; left: 10%;">â­</span>
            <span class="absolute text-3xl animate-float-delay" style="top: 20%; right: 15%;">ğŸŒ¸</span>
            <span class="absolute text-4xl animate-float" style="top: 60%; left: 5%;">ğŸ’–</span>
            <span class="absolute text-3xl animate-float-delay" style="top: 70%; right: 10%;">âœ¨</span>
            <span class="absolute text-4xl animate-float" style="top: 40%; right: 20%;">ğŸ¦‹</span>
            <span class="absolute text-3xl animate-float-delay" style="top: 80%; left: 20%;">ğŸŒˆ</span>
        </div>

        <div class="bg-white/95 backdrop-blur p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center mx-4 border-4 border-pink-200 relative z-10">
            <div class="text-6xl mb-4 animate-float">ğŸ°</div>
            <h2 class="text-2xl font-black bg-gradient-to-r from-pink-400 via-purple-400 to-blue-400 bg-clip-text text-transparent mb-4">ã‚ãã‚ããƒ©ãƒ³ãƒ‰</h2>
            <p class="text-pink-400 mb-6 font-bold text-sm">âœ¨ ã‚ã„ã“ã¨ã° ã‚’ã„ã‚Œã¦ã­ âœ¨</p>

            <input type="text" id="pass-input" placeholder="ã²ã‚‰ãŒãª" autocomplete="off"
                class="w-full bg-pink-50 border-2 border-pink-200 rounded-full py-3 px-6 text-center text-xl font-bold mb-4 focus:outline-none focus:border-pink-400 text-gray-700 placeholder-pink-300">

            <button onclick="checkPass()" class="w-full bg-gradient-to-r from-pink-400 to-purple-400 hover:from-pink-500 hover:to-purple-500 text-white font-bold py-3 rounded-full shadow-lg active:scale-95 transition text-lg">
                ğŸ”“ ã‚ã‘ã‚‹ï¼
            </button>
            <p id="error-msg" class="text-red-400 font-bold mt-4 hidden">ã¡ãŒã†ã¿ãŸã„... ğŸ’¦</p>
        </div>
    </div>

    <!-- â–¼â–¼â–¼ 2. ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ (å¸¸æ™‚è¡¨ç¤º) â–¼â–¼â–¼ -->
    <nav class="bg-white/90 backdrop-blur-md sticky top-0 z-50 px-4 py-3 shadow-lg border-b-4 border-pink-300 flex justify-between items-center">
        <div class="flex items-center gap-2 cursor-pointer select-none" onclick="AppSystem.loadHome()">
            <span class="text-2xl animate-float">ğŸ°</span>
            <h1 class="font-black text-lg md:text-xl bg-gradient-to-r from-pink-400 via-purple-400 to-blue-400 bg-clip-text text-transparent tracking-wider">ã‚ãã‚ããƒ©ãƒ³ãƒ‰</h1>
        </div>
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-r from-yellow-300 to-orange-300 text-white px-4 py-1.5 rounded-full font-black shadow-md flex items-center gap-2 select-none border-2 border-yellow-400">
                <span class="text-xl animate-twinkle">â­</span>
                <span id="star-count" class="text-xl">0</span>
            </div>
            <button onclick="AppSystem.launchApp('parent_v1.js', 'ã»ã”ã—ã‚ƒã‚ˆã†')" class="text-gray-400 hover:text-pink-400 text-sm font-bold px-2 py-1 rounded transition" title="ä¿è­·è€…ç”¨">
                ğŸ‘¤
            </button>
        </div>
    </nav>

    <!-- â–¼â–¼â–¼ 3. ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ (ã“ã“ã«ã‚¢ãƒ—ãƒªã‚„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹) â–¼â–¼â–¼ -->
    <main id="app-container" class="flex-1 overflow-y-auto relative scroll-smooth">
        <!-- åˆæœŸãƒ­ãƒ¼ãƒ‰ä¸­ã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„ã‹ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤º -->
    </main>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, query, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCcM38mjkSVXJDFJaxqZ8PXCuLr-bwNfsU",
            authDomain: "family-app-1006.firebaseapp.com",
            projectId: "family-app-1006",
            storageBucket: "family-app-1006.firebasestorage.app",
            messagingSenderId: "516894951381",
            appId: "1:516894951381:web:76d0b88cb8c406d6791f5c"
        };

        const firebaseApp = initializeApp(firebaseConfig, 'main-app');
        const db = getFirestore(firebaseApp);

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        window.logAppUsage = async (appTitle, appFile) => {
            try {
                await addDoc(collection(db, 'app_usage_logs'), {
                    appTitle,
                    appFile,
                    date: getTodayString(),
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error('ä½¿ç”¨ãƒ­ã‚°è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', e);
            }
        };

        window.logQuizResult = async (appTitle, question, isCorrect, details = {}) => {
            try {
                await addDoc(collection(db, 'quiz_logs'), {
                    appTitle,
                    question,
                    isCorrect,
                    details,
                    date: getTodayString(),
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error('ã‚¯ã‚¤ã‚ºãƒ­ã‚°è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', e);
            }
        };

        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
        function getTodayString() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }
        window.getTodayString = getTodayString;

        // è¡¨ç¤ºã™ã‚‹ã‚¢ãƒ—ãƒªIDã‚’å–å¾—
        window.getVisibleAppIds = async () => {
            try {
                const docRef = doc(db, 'settings', 'visible_apps');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data().appIds || null;
                }
                return null; // è¨­å®šãŒãªã„å ´åˆã¯å…¨è¡¨ç¤º
            } catch (e) {
                console.error('è¡¨ç¤ºè¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
                return null;
            }
        };

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šçŸ¥: æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
        window.messageUnreadCount = 0;
        window.messageUnsubscribe = null;

        window.startMessageListener = () => {
            if (window.messageUnsubscribe) return; // æ—¢ã«ç›£è¦–ä¸­

            const q = query(
                collection(db, 'family_messages'),
                where('to', '==', 'child'),
                where('read', '==', false)
            );

            window.messageUnsubscribe = onSnapshot(q, (snapshot) => {
                window.messageUnreadCount = snapshot.size;
                // ãƒãƒƒã‚¸æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
                window.dispatchEvent(new CustomEvent('messageCountUpdate', {
                    detail: { count: snapshot.size }
                }));
            }, (error) => {
                console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç›£è¦–ã‚¨ãƒ©ãƒ¼:', error);
            });
        };

        window.stopMessageListener = () => {
            if (window.messageUnsubscribe) {
                window.messageUnsubscribe();
                window.messageUnsubscribe = null;
            }
        };
    </script>

    <!-- â–¼â–¼â–¼ 4. ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼ -->
    <script>
        // --- è¨­å®š: åˆè¨€è‘‰ ---
        const SECRET_WORD = "ã±ã±ã ã„ã™ã";
        const LOCK_KEY = "papa_app_unlocked_v1";

        // --- æ—¥ä»˜ã”ã¨ã®ã‚¹ã‚¿ãƒ¼ç®¡ç† ---
        const getStarKey = () => `kids_stars_${window.getTodayString ? window.getTodayString() : new Date().toISOString().split('T')[0]}`;

        // --- ãƒ­ãƒƒã‚¯è§£é™¤å‡¦ç† ---
        window.addEventListener('DOMContentLoaded', () => { 
            // ã™ã§ã«è§£é™¤æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
            if(localStorage.getItem(LOCK_KEY) === 'true') {
                unlockApp(); 
            }
            // Enterã‚­ãƒ¼å¯¾å¿œ
            document.getElementById('pass-input').addEventListener('keypress', (e)=>{
                if(e.key==='Enter') checkPass();
            });
        });

        function checkPass() {
            const input = document.getElementById('pass-input');
            const errorMsg = document.getElementById('error-msg');
            
            if(input.value === SECRET_WORD) {
                localStorage.setItem(LOCK_KEY, 'true');
                unlockApp();
            } else {
                errorMsg.classList.remove('hidden');
                // æºã‚Œã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                const box = input.parentElement;
                box.classList.remove('animate-shake');
                void box.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼
                box.classList.add('animate-shake');
                input.value = '';
                input.focus();
            }
        }

        function unlockApp() {
            const ls = document.getElementById('lock-screen');
            ls.style.transition = "opacity 0.5s ease";
            ls.style.opacity = "0";
            // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå¾Œã«ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•
            setTimeout(()=>{
                ls.style.display="none";
                AppSystem.init();
            }, 500);
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        window.addEventListener('messageCountUpdate', (e) => {
            AppSystem.updateMessageBadge();
        });

        // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ  ---
        const AppSystem = {
            registry: [],
            visibleAppIds: null,
            currentAppCleanup: null,

            // åˆæœŸåŒ–: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            async init() {
                this.updateStars();
                try {
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãã§å–å¾—
                    const res = await fetch(`./apps/registry.json?t=${Date.now()}`);
                    if(!res.ok) throw new Error("File not found");
                    this.registry = await res.json();

                    // è¡¨ç¤ºè¨­å®šã‚’å–å¾—
                    if (window.getVisibleAppIds) {
                        this.visibleAppIds = await window.getVisibleAppIds();
                    }

                    this.loadHome();
                } catch(e) {
                    console.error(e);
                    document.getElementById('app-container').innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-white text-center p-4">
                            <div class="text-6xl mb-4">ğŸ˜¢</div>
                            <p class="font-bold text-xl">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«ã—ã£ã±ã„ã—ãŸã‚ˆ</p>
                            <p class="text-sm mt-2 opacity-80">ãƒ‘ã‚½ã‚³ãƒ³ã®è¨­å®šã‚’ç¢ºèªã—ã¦ã­</p>
                            <p class="text-xs mt-4 opacity-50 font-mono">${e.message}</p>
                        </div>`;
                }
            },

            // ãƒ›ãƒ¼ãƒ ç”»é¢ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ã®æç”»
            async loadHome() {
                // å‰ã®ã‚¢ãƒ—ãƒªã®å¾Œç‰‡ä»˜ã‘
                if(this.currentAppCleanup) {
                    this.currentAppCleanup();
                    this.currentAppCleanup = null;
                }

                // è¡¨ç¤ºè¨­å®šã‚’å†èª­ã¿è¾¼ã¿
                if (window.getVisibleAppIds) {
                    this.visibleAppIds = await window.getVisibleAppIds();
                }
                
                // ã‚«ãƒ¼ãƒ‰ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
                const renderCards = (apps, colorTheme) => {
                    if(apps.length === 0) return '<div class="col-span-full text-gray-400 font-bold p-8 text-center bg-white/50 rounded-xl">ã¾ã  ã‚¢ãƒ—ãƒªãŒãªã„ã‚ˆ ğŸš§</div>';
                    
                    return apps.map(app => `
                    <div onclick="AppSystem.launchApp('${app.file}', '${app.title}')" 
                         class="bg-white rounded-3xl p-6 shadow-lg border-b-8 border-${app.color} flex flex-col items-center cursor-pointer transform transition-all duration-200 hover:scale-105 hover:-translate-y-1 active:scale-95 group relative overflow-hidden">
                        
                        <!-- èƒŒæ™¯ã®ã‚­ãƒ©ã‚­ãƒ©è£…é£¾ï¼ˆãƒ›ãƒãƒ¼æ™‚ï¼‰ -->
                        <div class="absolute inset-0 bg-gradient-to-b from-transparent to-${app.color}/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        
                        <div class="bg-${app.color.split('-')[0]}-50 w-24 h-24 rounded-full flex items-center justify-center text-5xl mb-4 group-hover:scale-110 group-hover:rotate-12 transition-transform duration-300 shadow-inner z-10">
                            ${app.icon}
                        </div>
                        <h4 class="text-xl font-black text-gray-700 mb-1 z-10 text-center leading-tight">${app.title}</h4>
                        <p class="text-sm text-gray-500 font-bold opacity-70 mb-4 z-10 text-center">${app.desc}</p>
                        
                        <div class="mt-auto bg-${app.color} text-white font-bold py-2 px-8 rounded-full text-sm shadow-md group-hover:shadow-lg z-10">
                            ã‚ãã¶ï¼
                        </div>
                    </div>`).join('');
                };

                // è¡¨ç¤ºè¨­å®šã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const allApps = this.visibleAppIds
                    ? this.registry.filter(app => this.visibleAppIds.includes(app.id))
                    : this.registry;

                document.getElementById('app-container').innerHTML = `
                    <!-- æµ®ã‹ã¶è£…é£¾ï¼ˆãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸å°‚ç”¨ï¼‰ -->
                    <div class="floating-decorations" id="floating-deco"></div>

                    <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
                    <div class="min-h-full bg-gradient-to-b from-pink-50/80 via-purple-50/80 to-blue-50/80 pt-6 px-4 pb-8 relative z-20">
                        <!-- è£…é£¾ -->
                        <div class="absolute top-4 left-4 text-3xl opacity-40 animate-float">ğŸŒ¸</div>
                        <div class="absolute top-8 right-8 text-3xl opacity-40 animate-float-delay">ğŸ’–</div>
                        <div class="absolute top-1/4 left-8 text-2xl opacity-30 animate-float">âœ¨</div>
                        <div class="absolute top-1/3 right-4 text-2xl opacity-30 animate-float-delay">ğŸ¦‹</div>
                        <div class="absolute bottom-1/4 left-4 text-2xl opacity-30 animate-float">ğŸŒˆ</div>
                        <div class="absolute bottom-1/3 right-8 text-2xl opacity-30 animate-float-delay">â­</div>

                        <div class="max-w-5xl mx-auto relative z-10">
                            <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
                            <div class="text-center mb-8">
                                <div class="flex items-center justify-center gap-3 mb-2">
                                    <span class="text-4xl animate-float">ğŸ°</span>
                                    <h2 class="text-3xl md:text-4xl font-black bg-gradient-to-r from-pink-400 via-purple-400 to-blue-400 bg-clip-text text-transparent">
                                        ãªã«ã—ã¦ ã‚ãã¶ï¼Ÿ
                                    </h2>
                                    <span class="text-4xl animate-float-delay">âœ¨</span>
                                </div>
                            </div>

                            <!-- ã‚¢ãƒ—ãƒªä¸€è¦§ -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                                ${allApps.length === 0 ? '<div class="col-span-full text-gray-400 font-bold p-8 text-center bg-white/50 rounded-xl">ã¾ã  ã‚¢ãƒ—ãƒªãŒãªã„ã‚ˆ ğŸš§</div>' : allApps.map(app => `
                                    <div onclick="AppSystem.launchApp('${app.file}', '${app.title}')"
                                         class="bg-white/90 backdrop-blur rounded-3xl p-6 shadow-lg border-4 border-white hover:border-pink-200 flex flex-col items-center cursor-pointer transform transition-all duration-200 hover:scale-105 hover:-translate-y-2 active:scale-95 group relative overflow-hidden"
                                         data-app-id="${app.id}">

                                        <!-- é€šçŸ¥ãƒãƒƒã‚¸ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ãƒ—ãƒªç”¨ï¼‰ -->
                                        ${app.id === 'family_message_01' ? '<div id="message-badge" class="absolute top-2 right-2 bg-red-500 text-white text-sm font-black w-7 h-7 rounded-full flex items-center justify-center shadow-lg z-20 hidden animate-bounce">0</div>' : ''}

                                        <!-- èƒŒæ™¯ã®ã‚­ãƒ©ã‚­ãƒ©è£…é£¾ï¼ˆãƒ›ãƒãƒ¼æ™‚ï¼‰ -->
                                        <div class="absolute inset-0 bg-gradient-to-b from-pink-100/50 to-purple-100/50 opacity-0 group-hover:opacity-100 transition-opacity"></div>

                                        <div class="bg-gradient-to-br from-${app.color.split('-')[0]}-100 to-${app.color.split('-')[0]}-200 w-24 h-24 rounded-full flex items-center justify-center text-5xl mb-4 group-hover:scale-110 group-hover:rotate-12 transition-transform duration-300 shadow-lg z-10 border-4 border-white">
                                            ${app.icon}
                                        </div>
                                        <h4 class="text-xl font-black text-gray-700 mb-1 z-10 text-center leading-tight">${app.title}</h4>
                                        <p class="text-sm text-gray-500 font-bold opacity-70 mb-4 z-10 text-center">${app.desc}</p>

                                        <div class="mt-auto bg-gradient-to-r from-pink-400 to-purple-400 text-white font-bold py-2 px-8 rounded-full text-sm shadow-md group-hover:shadow-lg group-hover:from-pink-500 group-hover:to-purple-500 z-10 transition-all">
                                            ã‚ãã¶ï¼
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
                        <footer class="text-center py-8 text-pink-300 text-xs font-bold">
                            âœ¨ ã‚ãã‚ããƒ©ãƒ³ãƒ‰ âœ¨
                        </footer>
                    </div>
                `;

                // æµ®ã‹ã¶è£…é£¾ã‚’ç”Ÿæˆ
                createFloatingDecorations();

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šçŸ¥ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹
                if (window.startMessageListener) {
                    window.startMessageListener();
                }

                // ãƒãƒƒã‚¸ã‚’æ›´æ–°
                this.updateMessageBadge();
            },

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒƒã‚¸æ›´æ–°
            updateMessageBadge() {
                const badge = document.getElementById('message-badge');
                if (badge) {
                    const count = window.messageUnreadCount || 0;
                    if (count > 0) {
                        badge.textContent = count > 99 ? '99+' : count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            },

            // ã‚¢ãƒ—ãƒªèµ·å‹•å‡¦ç†
            async launchApp(filename, title) {
                const container = document.getElementById('app-container');
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢
                container.innerHTML = `
                    <div class="h-full min-h-[80vh] bg-white flex flex-col items-center justify-center font-bold text-gray-400 animate-pulse">
                        <div class="text-6xl mb-4 animate-spin-slow">ğŸ¡</div>
                        <p class="text-xl text-blue-400">ã˜ã‚…ã‚“ã³ã—ã¦ã„ã‚‹ã‚ˆ...</p>
                        <p class="text-sm mt-2 opacity-50">${title}</p>
                    </div>`;
                
                try {
                    // å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    const module = await import(`./apps/${filename}?t=${Date.now()}`);
                    
                    // ç”»é¢ã‚¯ãƒªã‚¢ï¼†ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ
                    container.innerHTML = '';
                    const appRoot = document.createElement('div');
                    // å…¨ç”»é¢ãƒ•ã‚£ãƒƒãƒˆã•ã›ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«
                    appRoot.className = "w-full h-full min-h-[calc(100vh-80px)] bg-white md:rounded-t-3xl shadow-sm md:p-4 animate-pop overflow-hidden";
                    container.appendChild(appRoot);
                    
                    // ä½¿ç”¨ãƒ­ã‚°ã‚’è¨˜éŒ²
                    if (window.logAppUsage) {
                        window.logAppUsage(title, filename);
                    }

                    // ã‚¢ãƒ—ãƒªå®Ÿè¡Œ
                    this.currentAppCleanup = module.default.launch(appRoot, {
                        addScore: (points) => {
                            const current = parseInt(localStorage.getItem(getStarKey()) || '0');
                            const newScore = current + points;
                            localStorage.setItem(getStarKey(), newScore);
                            this.updateStars();
                        },
                        goHome: () => this.loadHome(),
                        playSound: (type) => console.log('Playing sound:', type),
                        logQuizResult: window.logQuizResult || (() => {})
                    });

                } catch(e) { 
                    console.error(e);
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å°‘ã—å¾…ã£ã¦ãƒ›ãƒ¼ãƒ ã«æˆ»ã™ï¼ˆä¸€ç¬ã ã¨æ°—ã¥ã‹ãªã„ãŸã‚ï¼‰
                    setTimeout(() => {
                        alert(`ã€Œ${title}ã€ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ã­ã€‚`);
                        this.loadHome(); 
                    }, 500);
                }
            },

            // ã‚¹ã‚¿ãƒ¼è¡¨ç¤ºæ›´æ–°ï¼ˆæ—¥ä»˜ã”ã¨ã«ãƒªã‚»ãƒƒãƒˆï¼‰
            updateStars() {
                const count = localStorage.getItem(getStarKey()) || '0';
                const el = document.getElementById('star-count');
                // æ•°å­—ãŒå¢—ãˆãŸã¨ãã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ä»˜ã‘æ›¿ãˆ
                el.classList.remove('scale-125');
                void el.offsetWidth;
                el.textContent = count;
                el.classList.add('transition', 'transform', 'duration-300', 'scale-125');
                setTimeout(() => el.classList.remove('scale-125'), 300);
            }
        };

        // æµ®ã‹ã¶è£…é£¾ã‚’ç”Ÿæˆï¼ˆãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸å°‚ç”¨ï¼‰
        function createFloatingDecorations() {
            const container = document.getElementById('floating-deco');
            if (!container) return;

            const decorations = ['â­', 'ğŸ’–', 'ğŸŒ¸', 'âœ¨', 'ğŸ¦‹', 'ğŸŒˆ', 'ğŸ’«', 'ğŸ€', 'ğŸ’•', 'ğŸŒŸ'];

            for (let i = 0; i < 15; i++) {
                const span = document.createElement('span');
                span.textContent = decorations[Math.floor(Math.random() * decorations.length)];
                span.style.left = Math.random() * 100 + '%';
                span.style.animationDelay = Math.random() * 15 + 's';
                span.style.animationDuration = (15 + Math.random() * 10) + 's';
                span.style.fontSize = (16 + Math.random() * 16) + 'px';
                container.appendChild(span);
            }
        }
    </script>
</body>
</html>
