<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ãã‚ããƒ©ãƒ³ãƒ‰</title>
    <!-- ãƒ•ã‚©ãƒ³ãƒˆ: ãœã‚“ã¾ã‚‹ã‚´ã‚·ãƒƒã‚¯ -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Zen Maru Gothic"', 'sans-serif'] },
                    colors: { 
                        sky: { 300: '#7DD3FC', 100: '#E0F2FE' }, 
                        grass: { 100: '#DCFCE7' }, 
                        paper: '#FFF7ED' 
                    },
                    animation: { 
                        'float': 'float 6s ease-in-out infinite', 
                        'cloud': 'cloud 60s linear infinite', 
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'pop': 'pop 0.3s ease-out forwards',
                        'spin-slow': 'spin 3s linear infinite'
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        cloud: { '0%': { backgroundPosition: '0 0' }, '100%': { backgroundPosition: '1000px 0' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } },
                        pop: { '0%': { transform: 'scale(0.8)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: "Zen Maru Gothic", sans-serif; 
            background-color: #7DD3FC; 
            overflow-x: hidden; 
            touch-action: manipulation; /* ã‚¹ãƒãƒ›ã§ã®ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§é˜²æ­¢ */
        }
        /* é›²ã®èƒŒæ™¯ãƒ‘ã‚¿ãƒ¼ãƒ³ */
        .bg-clouds { 
            background-image: radial-gradient(circle at 50% 50%, white 20%, transparent 20%), radial-gradient(circle at 60% 60%, white 20%, transparent 20%); 
            background-size: 100px 100px; 
            opacity: 0.4; 
        }
        /* ãƒ­ãƒƒã‚¯ç”»é¢ç”¨ */
        #lock-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #7DD3FC; z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼è£…é£¾ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.5); border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800">

    <!-- â–¼â–¼â–¼ 1. ãƒ­ãƒƒã‚¯ç”»é¢ (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£) â–¼â–¼â–¼ -->
    <div id="lock-screen">
        <div class="bg-white p-8 rounded-3xl shadow-xl max-w-sm w-full text-center mx-4 border-b-8 border-blue-200">
            <div class="text-6xl mb-4">ğŸ”</div>
            <h2 class="text-2xl font-black text-gray-700 mb-4">ã‚ãã‚ããƒ©ãƒ³ãƒ‰</h2>
            <p class="text-gray-500 mb-6 font-bold text-sm">ã‚ã„ã“ã¨ã° ã‚’ã„ã‚Œã¦ã­</p>
            
            <input type="text" id="pass-input" placeholder="ã²ã‚‰ãŒãª" autocomplete="off"
                class="w-full bg-gray-100 border-2 border-gray-300 rounded-full py-3 px-6 text-center text-xl font-bold mb-4 focus:outline-none focus:border-blue-400 text-gray-700 placeholder-gray-400">
            
            <button onclick="checkPass()" class="w-full bg-blue-400 hover:bg-blue-500 text-white font-bold py-3 rounded-full shadow-md active:scale-95 transition text-lg">
                ã‚ã‘ã‚‹ï¼
            </button>
            <p id="error-msg" class="text-red-400 font-bold mt-4 hidden">ã¡ãŒã†ã¿ãŸã„...</p>
        </div>
    </div>

    <!-- â–¼â–¼â–¼ 2. ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ (å¸¸æ™‚è¡¨ç¤º) â–¼â–¼â–¼ -->
    <nav class="bg-white/95 backdrop-blur-sm sticky top-0 z-50 px-4 py-3 shadow-md border-b-4 border-yellow-400 flex justify-between items-center">
        <div class="flex items-center gap-2 cursor-pointer select-none" onclick="AppSystem.loadHome()">
            <span class="text-2xl">ğŸ¡</span>
            <h1 class="font-black text-lg md:text-xl text-blue-500 tracking-wider">ã‚ãã‚ããƒ©ãƒ³ãƒ‰</h1>
        </div>
        <div class="flex items-center gap-3">
            <div class="bg-yellow-400 text-white px-4 py-1.5 rounded-full font-black shadow-inner flex items-center gap-2 select-none">
                <span class="text-xl">â­</span>
                <span id="star-count" class="text-xl">0</span>
            </div>
            <button onclick="AppSystem.launchApp('parent_v1.js', 'ã»ã”ã—ã‚ƒã‚ˆã†')" class="text-gray-400 hover:text-gray-600 text-sm font-bold px-2 py-1 rounded transition" title="ä¿è­·è€…ç”¨">
                ğŸ‘¤
            </button>
        </div>
    </nav>

    <!-- â–¼â–¼â–¼ 3. ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ (ã“ã“ã«ã‚¢ãƒ—ãƒªã‚„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹) â–¼â–¼â–¼ -->
    <main id="app-container" class="flex-1 overflow-y-auto relative scroll-smooth">
        <!-- åˆæœŸãƒ­ãƒ¼ãƒ‰ä¸­ã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„ã‹ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤º -->
    </main>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCcM38mjkSVXJDFJaxqZ8PXCuLr-bwNfsU",
            authDomain: "family-app-1006.firebaseapp.com",
            projectId: "family-app-1006",
            storageBucket: "family-app-1006.firebasestorage.app",
            messagingSenderId: "516894951381",
            appId: "1:516894951381:web:76d0b88cb8c406d6791f5c"
        };

        const firebaseApp = initializeApp(firebaseConfig, 'main-app');
        const db = getFirestore(firebaseApp);

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        window.logAppUsage = async (appTitle, appFile) => {
            try {
                await addDoc(collection(db, 'app_usage_logs'), {
                    appTitle,
                    appFile,
                    date: getTodayString(),
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error('ä½¿ç”¨ãƒ­ã‚°è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', e);
            }
        };

        window.logQuizResult = async (appTitle, question, isCorrect, details = {}) => {
            try {
                await addDoc(collection(db, 'quiz_logs'), {
                    appTitle,
                    question,
                    isCorrect,
                    details,
                    date: getTodayString(),
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error('ã‚¯ã‚¤ã‚ºãƒ­ã‚°è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', e);
            }
        };

        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
        function getTodayString() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }
        window.getTodayString = getTodayString;
    </script>

    <!-- â–¼â–¼â–¼ 4. ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼ -->
    <script>
        // --- è¨­å®š: åˆè¨€è‘‰ ---
        const SECRET_WORD = "ã±ã±ã ã„ã™ã";
        const LOCK_KEY = "papa_app_unlocked_v1";

        // --- æ—¥ä»˜ã”ã¨ã®ã‚¹ã‚¿ãƒ¼ç®¡ç† ---
        const getStarKey = () => `kids_stars_${window.getTodayString ? window.getTodayString() : new Date().toISOString().split('T')[0]}`;

        // --- ãƒ­ãƒƒã‚¯è§£é™¤å‡¦ç† ---
        window.addEventListener('DOMContentLoaded', () => { 
            // ã™ã§ã«è§£é™¤æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
            if(localStorage.getItem(LOCK_KEY) === 'true') {
                unlockApp(); 
            }
            // Enterã‚­ãƒ¼å¯¾å¿œ
            document.getElementById('pass-input').addEventListener('keypress', (e)=>{
                if(e.key==='Enter') checkPass();
            });
        });

        function checkPass() {
            const input = document.getElementById('pass-input');
            const errorMsg = document.getElementById('error-msg');
            
            if(input.value === SECRET_WORD) {
                localStorage.setItem(LOCK_KEY, 'true');
                unlockApp();
            } else {
                errorMsg.classList.remove('hidden');
                // æºã‚Œã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                const box = input.parentElement;
                box.classList.remove('animate-shake');
                void box.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼
                box.classList.add('animate-shake');
                input.value = '';
                input.focus();
            }
        }

        function unlockApp() {
            const ls = document.getElementById('lock-screen');
            ls.style.transition = "opacity 0.5s ease"; 
            ls.style.opacity = "0";
            // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå¾Œã«ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•
            setTimeout(()=>{ 
                ls.style.display="none"; 
                AppSystem.init(); 
            }, 500);
        }

        // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ  ---
        const AppSystem = {
            registry: [], 
            currentAppCleanup: null,

            // åˆæœŸåŒ–: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            async init() {
                this.updateStars();
                try {
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãã§å–å¾—
                    const res = await fetch(`./apps/registry.json?t=${Date.now()}`);
                    if(!res.ok) throw new Error("File not found");
                    this.registry = await res.json();
                    this.loadHome();
                } catch(e) { 
                    console.error(e);
                    document.getElementById('app-container').innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-white text-center p-4">
                            <div class="text-6xl mb-4">ğŸ˜¢</div>
                            <p class="font-bold text-xl">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«ã—ã£ã±ã„ã—ãŸã‚ˆ</p>
                            <p class="text-sm mt-2 opacity-80">ãƒ‘ã‚½ã‚³ãƒ³ã®è¨­å®šã‚’ç¢ºèªã—ã¦ã­</p>
                            <p class="text-xs mt-4 opacity-50 font-mono">${e.message}</p>
                        </div>`; 
                }
            },

            // ãƒ›ãƒ¼ãƒ ç”»é¢ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ã®æç”»
            loadHome() {
                // å‰ã®ã‚¢ãƒ—ãƒªã®å¾Œç‰‡ä»˜ã‘
                if(this.currentAppCleanup) { 
                    this.currentAppCleanup(); 
                    this.currentAppCleanup = null; 
                }
                
                // ã‚«ãƒ¼ãƒ‰ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
                const renderCards = (apps, colorTheme) => {
                    if(apps.length === 0) return '<div class="col-span-full text-gray-400 font-bold p-8 text-center bg-white/50 rounded-xl">ã¾ã  ã‚¢ãƒ—ãƒªãŒãªã„ã‚ˆ ğŸš§</div>';
                    
                    return apps.map(app => `
                    <div onclick="AppSystem.launchApp('${app.file}', '${app.title}')" 
                         class="bg-white rounded-3xl p-6 shadow-lg border-b-8 border-${app.color} flex flex-col items-center cursor-pointer transform transition-all duration-200 hover:scale-105 hover:-translate-y-1 active:scale-95 group relative overflow-hidden">
                        
                        <!-- èƒŒæ™¯ã®ã‚­ãƒ©ã‚­ãƒ©è£…é£¾ï¼ˆãƒ›ãƒãƒ¼æ™‚ï¼‰ -->
                        <div class="absolute inset-0 bg-gradient-to-b from-transparent to-${app.color}/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        
                        <div class="bg-${app.color.split('-')[0]}-50 w-24 h-24 rounded-full flex items-center justify-center text-5xl mb-4 group-hover:scale-110 group-hover:rotate-12 transition-transform duration-300 shadow-inner z-10">
                            ${app.icon}
                        </div>
                        <h4 class="text-xl font-black text-gray-700 mb-1 z-10 text-center leading-tight">${app.title}</h4>
                        <p class="text-sm text-gray-500 font-bold opacity-70 mb-4 z-10 text-center">${app.desc}</p>
                        
                        <div class="mt-auto bg-${app.color} text-white font-bold py-2 px-8 rounded-full text-sm shadow-md group-hover:shadow-lg z-10">
                            ã‚ãã¶ï¼
                        </div>
                    </div>`).join('');
                };

                const studyApps = this.registry.filter(a => a.category === 'study');
                const playApps = this.registry.filter(a => a.category === 'play');

                document.getElementById('app-container').innerHTML = `
                    <!-- ã‚¨ãƒªã‚¢1: ã¾ãªã³ã®æ£® (Study) -->
                    <div class="bg-grass-100 rounded-t-[40px] pt-8 px-4 pb-12 shadow-[0_-10px_30px_rgba(0,0,0,0.1)] relative z-20">
                        <div class="max-w-5xl mx-auto">
                            <div class="flex items-center justify-center gap-3 mb-8">
                                <span class="text-4xl filter drop-shadow-sm">âœï¸</span>
                                <h3 class="text-2xl md:text-3xl font-black text-green-600 tracking-widest">ã¾ãªã³ã® ã‚‚ã‚Š</h3>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                                ${renderCards(studyApps, 'green')}
                            </div>
                        </div>
                    </div>

                    <!-- ã‚¨ãƒªã‚¢2: ã‚ãã³ã®åºƒå ´ (Play) -->
                    <div class="bg-paper rounded-t-[40px] -mt-6 pt-8 px-4 pb-16 shadow-[0_-10px_20px_rgba(0,0,0,0.05)] relative z-30">
                        <div class="max-w-5xl mx-auto">
                            <div class="flex items-center justify-center gap-3 mb-8">
                                <span class="text-4xl filter drop-shadow-sm">ğŸ®</span>
                                <h3 class="text-2xl md:text-3xl font-black text-orange-500 tracking-widest">ã‚ãã³ã® ã²ã‚ã°</h3>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                                ${renderCards(playApps, 'orange')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
                    <footer class="w-full text-center py-6 text-gray-400 text-xs font-bold z-40">
                        &copy; ã‚ãã‚ããƒ©ãƒ³ãƒ‰
                    </footer>
                `;
            },

            // ã‚¢ãƒ—ãƒªèµ·å‹•å‡¦ç†
            async launchApp(filename, title) {
                const container = document.getElementById('app-container');
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢
                container.innerHTML = `
                    <div class="h-full min-h-[80vh] bg-white flex flex-col items-center justify-center font-bold text-gray-400 animate-pulse">
                        <div class="text-6xl mb-4 animate-spin-slow">ğŸ¡</div>
                        <p class="text-xl text-blue-400">ã˜ã‚…ã‚“ã³ã—ã¦ã„ã‚‹ã‚ˆ...</p>
                        <p class="text-sm mt-2 opacity-50">${title}</p>
                    </div>`;
                
                try {
                    // å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    const module = await import(`./apps/${filename}?t=${Date.now()}`);
                    
                    // ç”»é¢ã‚¯ãƒªã‚¢ï¼†ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ
                    container.innerHTML = '';
                    const appRoot = document.createElement('div');
                    // å…¨ç”»é¢ãƒ•ã‚£ãƒƒãƒˆã•ã›ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«
                    appRoot.className = "w-full h-full min-h-[calc(100vh-80px)] bg-white md:rounded-t-3xl shadow-sm md:p-4 animate-pop overflow-hidden";
                    container.appendChild(appRoot);
                    
                    // ä½¿ç”¨ãƒ­ã‚°ã‚’è¨˜éŒ²
                    if (window.logAppUsage) {
                        window.logAppUsage(title, filename);
                    }

                    // ã‚¢ãƒ—ãƒªå®Ÿè¡Œ
                    this.currentAppCleanup = module.default.launch(appRoot, {
                        addScore: (points) => {
                            const current = parseInt(localStorage.getItem(getStarKey()) || '0');
                            const newScore = current + points;
                            localStorage.setItem(getStarKey(), newScore);
                            this.updateStars();
                        },
                        goHome: () => this.loadHome(),
                        playSound: (type) => console.log('Playing sound:', type),
                        logQuizResult: window.logQuizResult || (() => {})
                    });

                } catch(e) { 
                    console.error(e);
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å°‘ã—å¾…ã£ã¦ãƒ›ãƒ¼ãƒ ã«æˆ»ã™ï¼ˆä¸€ç¬ã ã¨æ°—ã¥ã‹ãªã„ãŸã‚ï¼‰
                    setTimeout(() => {
                        alert(`ã€Œ${title}ã€ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ã­ã€‚`);
                        this.loadHome(); 
                    }, 500);
                }
            },

            // ã‚¹ã‚¿ãƒ¼è¡¨ç¤ºæ›´æ–°ï¼ˆæ—¥ä»˜ã”ã¨ã«ãƒªã‚»ãƒƒãƒˆï¼‰
            updateStars() {
                const count = localStorage.getItem(getStarKey()) || '0';
                const el = document.getElementById('star-count');
                // æ•°å­—ãŒå¢—ãˆãŸã¨ãã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ä»˜ã‘æ›¿ãˆ
                el.classList.remove('scale-125');
                void el.offsetWidth;
                el.textContent = count;
                el.classList.add('transition', 'transform', 'duration-300', 'scale-125');
                setTimeout(() => el.classList.remove('scale-125'), 300);
            }
        };
    </script>
</body>
</html>
